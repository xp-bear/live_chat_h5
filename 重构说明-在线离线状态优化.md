# 个人单聊在线/离线状态显示和删除方法重构说明

## 重构日期

2025 年 12 月 21 日

## 问题分析

### 原有问题

1. **在线用户管理混乱**: WebSocket 的 clients 对象和数据库存储数据不一致
2. **离线状态未正确显示**: 只显示在线用户,没有离线用户的概念
3. **删除逻辑不完整**: WebSocket 断开时删除数据库记录,但前端状态更新不及时
4. **私聊消息计数逻辑复杂**: 使用多层过滤,效率低且容易出错

## 重构内容

### 后端优化 (app.js)

#### 1. 优化客户端存储结构

```javascript
// 修改前
let clients = {}; // { username: WebSocket }

// 修改后
let clients = {}; // { username: { ws: WebSocket, userInfo: { user_img, create_time } } }
```

#### 2. 新增功能

- 在用户加入时发送当前在线用户列表
- 添加错误处理机制
- 优化广播消息的错误处理
- 保存用户完整信息(头像、加入时间等)

#### 3. 连接管理优化

```javascript
// 添加 currentUsername 变量跟踪当前连接的用户
let currentUsername = null;

// 优化 onclose 事件处理
ws.on("close", () => {
  if (currentUsername && clients[currentUsername]) {
    delete clients[currentUsername];
    broadcast({...});
  }
});

// 新增 onerror 事件处理
ws.on("error", (error) => {
  console.error("WebSocket 错误:", error);
  if (currentUsername && clients[currentUsername]) {
    delete clients[currentUsername];
  }
});
```

### 前端优化 (Chat.vue)

#### 1. 新增响应式变量

```javascript
// 在线状态映射表
const onlineStatusMap = ref({}); // { username: boolean }
```

#### 2. 新增计算属性 allChatUsers

统一管理所有聊天用户(在线+离线):

```javascript
const allChatUsers = computed(() => {
  // 获取所有有私聊消息的用户
  // 合并在线用户
  // 添加离线用户(有聊天记录但不在线的)
  // 按最后消息时间排序
});
```

#### 3. 优化函数

**新增函数:**

- `getUnreadCount(userName)`: 获取指定用户的未读消息数量

**优化函数:**

- `connect()`:
  - 处理服务器返回的在线用户列表
  - 更新在线状态映射表
  - 移除数据库操作,完全由 WebSocket 管理

**删除函数:**

- `chat_updateOnlineUser()`: 不再需要数据库同步
- `show_private_count()`: 复杂的显示逻辑
- `private_format_count()`: 简化为 getUnreadCount

#### 4. UI 改进

**个人单聊列表:**

- 显示在线和离线用户
- 在线用户显示绿色脉冲指示器
- 离线用户显示灰色指示器
- 添加在线/离线状态标签
- 优化未读消息徽章显示

**私聊弹窗:**

- 顶部显示对方在线/离线状态
- 状态指示器动态变化
- 状态文本动态显示

#### 5. 样式新增

```css
/* 离线指示器 */
.offline-indicator {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 3vw;
  height: 3vw;
  background: #ccc;
  border: 2px solid #fff;
  border-radius: 50%;
}

/* 离线状态点 */
.chat_all_top_dot_offline {
  display: inline-block;
  width: 2.1333vw;
  height: 2.1333vw;
  background: #ccc;
  border-radius: 50%;
  margin-right: 1.0667vw;
}

/* 在线/离线状态文本 */
.online-status-text {
  font-size: 2.6667vw;
  font-weight: 500;
  padding: 0.5333vw 1.6vw;
  border-radius: 8px;
  margin-left: 1.3333vw;
  margin-right: auto;

  &.status-online {
    color: #43e97b;
    background: rgba(67, 233, 123, 0.1);
  }

  &.status-offline {
    color: #999;
    background: rgba(153, 153, 153, 0.1);
  }
}
```

## 改进效果

### 1. 用户体验

- ✅ 可以看到离线用户和历史聊天记录
- ✅ 清晰的在线/离线状态指示
- ✅ 准确的未读消息计数
- ✅ 更流畅的状态更新

### 2. 代码质量

- ✅ 删除冗余的数据库操作
- ✅ 简化状态管理逻辑
- ✅ 统一的数据源(WebSocket 为主)
- ✅ 更好的错误处理

### 3. 性能优化

- ✅ 减少数据库查询
- ✅ 使用计算属性自动更新 UI
- ✅ 优化消息过滤逻辑

## 使用说明

### 在线/离线状态显示

- **绿色脉冲圆点** + "在线"标签 = 用户在线
- **灰色圆点** + "离线"标签 = 用户离线

### 聊天列表

- 在线用户排在前面
- 按最后消息时间排序
- 显示未读消息数量

### 私聊功能

- 可以与在线和离线用户聊天
- 打开聊天窗口自动清除未读标记
- 实时显示对方在线状态变化

## 注意事项

1. **WebSocket 连接管理**: 现在完全依赖 WebSocket 管理在线状态,确保 WebSocket 连接稳定
2. **状态同步**: 用户刷新页面后会重新连接,状态会自动更新
3. **离线消息**: 离线用户仍可接收消息(存储在数据库),上线后可查看
4. **性能考虑**: 大量用户时,考虑分页加载聊天列表

## 后续优化建议

1. 添加"最近联系人"功能
2. 实现消息推送通知
3. 添加"正在输入"状态提示
4. 优化大量用户场景下的性能
5. 添加用户搜索功能
