# 聊天记录功能测试指南

## 功能测试步骤

### 测试前准备

1. ✅ 数据库表已创建成功
2. ✅ 后端代码已更新（app.js、controllers、routes）
3. ✅ 前端代码已更新（Chat.vue、allApi.js）

### 测试步骤

#### 一、测试群聊历史记录

**步骤 1: 发送几条测试消息**

1. 打开聊天页面
2. 在群聊中发送几条测试消息（至少 3-5 条）
3. 可以使用不同用户发送消息测试

**步骤 2: 验证消息保存**

1. 打开数据库管理工具（如 Navicat 或 MySQL Workbench）
2. 运行查询：

```sql
SELECT * FROM chat_messages WHERE type = 'group' ORDER BY create_time DESC;
```

3. 确认消息已正确保存到数据库

**步骤 3: 测试历史加载**

1. 刷新页面或重新登录
2. 打开聊天页面
3. 确认之前发送的消息都显示出来了
4. 检查消息顺序是否正确（旧消息在上，新消息在下）
5. 检查消息内容、头像、时间是否正确

**步骤 4: 测试新旧消息混合**

1. 在已有历史消息的基础上
2. 发送新消息
3. 确认新消息正确添加到底部
4. 确认没有重复消息

---

#### 二、测试私聊历史记录

**步骤 1: 发送私聊消息**

1. 确保有至少 2 个用户在线
2. 点击某个用户，打开私聊窗口
3. 发送几条私聊消息
4. 对方也回复几条消息

**步骤 2: 验证私聊消息保存**

1. 打开数据库管理工具
2. 运行查询：

```sql
SELECT * FROM chat_messages
WHERE type = 'private'
AND ((from_user = '用户A' AND to_user = '用户B')
  OR (from_user = '用户B' AND to_user = '用户A'))
ORDER BY create_time DESC;
```

3. 确认私聊消息已正确保存

**步骤 3: 测试私聊历史加载**

1. 关闭私聊窗口
2. 刷新页面或重新登录
3. 再次点击同一个用户
4. 确认之前的私聊记录都显示出来了
5. 检查消息的发送方和接收方是否正确

**步骤 4: 测试多个私聊对象**

1. 与用户 A 聊天，发送几条消息
2. 切换到用户 B，发送几条消息
3. 再切换回用户 A
4. 确认显示的是与用户 A 的聊天记录
5. 确认没有混入用户 B 的消息

---

#### 三、测试消息类型

**步骤 1: 测试文本消息**

1. 发送纯文本消息
2. 发送包含表情的消息
3. 刷新页面确认都能正确显示

**步骤 2: 测试图片消息**

1. 发送图片消息（如果功能已实现）
2. 刷新页面确认图片能正确显示
3. 检查数据库中 msg_type 字段是否为 'image'

---

#### 四、性能测试

**步骤 1: 测试大量消息**

1. 模拟发送 100 条以上的消息
2. 刷新页面，观察加载速度
3. 确认页面不卡顿

**步骤 2: 测试并发**

1. 使用多个浏览器/设备同时登录不同用户
2. 同时发送消息
3. 确认所有消息都正确保存和显示

---

## 常见问题排查

### 问题 1: 页面刷新后历史消息不显示

**可能原因：**

- 数据库表未创建
- 后端 API 未正常工作
- 前端未正确调用加载函数

**排查步骤：**

1. 检查浏览器控制台是否有错误
2. 检查 Network 面板，确认 API 请求状态
3. 检查后端日志
4. 手动访问 API 测试：`http://localhost:3000/api/chat/messages/group`

### 问题 2: 新消息发送后未保存到数据库

**可能原因：**

- WebSocket 连接异常
- 后端保存函数出错
- 数据库连接问题

**排查步骤：**

1. 查看后端控制台是否有 "💾 消息已保存到数据库" 日志
2. 如果有错误信息，检查错误详情
3. 确认 app.js 中的保存函数被正确调用
4. 检查数据库连接配置

### 问题 3: 私聊历史加载错误

**可能原因：**

- 用户名参数传递错误
- 数据库查询条件问题

**排查步骤：**

1. 在 openPrivateChatPopup 函数中添加 console.log
2. 确认传递的用户名正确
3. 在浏览器控制台查看 API 请求参数
4. 手动测试 API：`http://localhost:3000/api/chat/messages/private?user1=张三&user2=李四`

### 问题 4: 消息重复显示

**可能原因：**

- 历史消息和新消息未正确区分
- WebSocket 消息处理有问题

**排查步骤：**

1. 检查 messages_p 数组是否被正确初始化
2. 确认 loadGroupHistory 只在页面加载时调用一次
3. 检查是否有消息去重逻辑

---

## 验收标准

### 基本功能

- [x] 群聊消息自动保存到数据库
- [x] 私聊消息自动保存到数据库
- [x] 页面加载时自动显示群聊历史
- [x] 打开私聊窗口时自动显示私聊历史
- [x] 消息显示顺序正确（时间升序）
- [x] 消息内容、头像、时间显示正确

### 用户体验

- [x] 历史消息加载流畅，无明显卡顿
- [x] 新消息和历史消息无缝衔接
- [x] 私聊切换时正确显示对应历史
- [x] 页面刷新后聊天记录不丢失

### 数据一致性

- [x] 发送的消息都保存到数据库
- [x] 数据库记录与前端显示一致
- [x] 多用户场景下数据不混乱
- [x] 支持文本和图片消息类型

---

## 快速验证命令

### 查看所有群聊消息

```sql
SELECT
  id,
  from_user,
  LEFT(message, 50) as message_preview,
  msg_type,
  create_time
FROM chat_messages
WHERE type = 'group'
ORDER BY create_time DESC
LIMIT 20;
```

### 查看所有私聊消息

```sql
SELECT
  id,
  from_user,
  to_user,
  LEFT(message, 50) as message_preview,
  msg_type,
  create_time
FROM chat_messages
WHERE type = 'private'
ORDER BY create_time DESC
LIMIT 20;
```

### 统计消息数量

```sql
SELECT
  type,
  COUNT(*) as count,
  COUNT(DISTINCT from_user) as unique_senders
FROM chat_messages
GROUP BY type;
```

### 查看最近 10 分钟的消息

```sql
SELECT * FROM chat_messages
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 10 MINUTE)
ORDER BY create_time DESC;
```

---

## 测试结果记录

### 测试人员：****\_\_****

### 测试日期：****\_\_****

| 测试项       | 预期结果         | 实际结果 | 通过/失败 | 备注 |
| ------------ | ---------------- | -------- | --------- | ---- |
| 群聊消息保存 | 消息保存到数据库 |          |           |      |
| 群聊历史加载 | 刷新后显示历史   |          |           |      |
| 私聊消息保存 | 消息保存到数据库 |          |           |      |
| 私聊历史加载 | 打开窗口显示历史 |          |           |      |
| 消息顺序     | 按时间升序排列   |          |           |      |
| 消息内容     | 内容完整正确     |          |           |      |
| 头像显示     | 头像正确显示     |          |           |      |
| 时间显示     | 时间格式正确     |          |           |      |
| 性能表现     | 加载流畅不卡顿   |          |           |      |
| 多用户场景   | 数据不混乱       |          |           |      |

---

## 注意事项

1. **测试环境准备**

   - 确保数据库服务正常运行
   - 确保后端服务已启动（端口 3000 和 5200）
   - 确保前端服务已启动
   - 使用多个浏览器或无痕模式模拟多用户

2. **数据清理**

   - 测试前可以清空 chat_messages 表：`TRUNCATE TABLE chat_messages;`
   - 测试完成后可以保留数据用于演示

3. **浏览器开发工具**

   - 打开开发者工具（F12）
   - 查看 Console 标签的日志输出
   - 查看 Network 标签的 API 请求
   - 查看 Application 标签的本地存储

4. **日志查看**
   - 后端日志会显示消息保存状态
   - 前端控制台会显示加载的历史消息
   - 注意查看是否有错误信息
