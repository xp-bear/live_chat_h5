# 聊天记录功能使用指南

## 功能概述

此功能实现了聊天记录的持久化存储，包括群聊和单聊消息。用户下次打开聊天页面时，会自动加载历史消息记录。

## 数据库表结构

### chat_messages 表

存储所有聊天消息记录，包括群聊和私聊。

| 字段名      | 类型         | 说明                               |
| ----------- | ------------ | ---------------------------------- |
| id          | INT          | 消息 ID（主键，自增）              |
| type        | VARCHAR(20)  | 消息类型：group-群聊, private-私聊 |
| from_user   | VARCHAR(100) | 发送者用户名                       |
| to_user     | VARCHAR(100) | 接收者用户名（仅私聊使用）         |
| message     | TEXT         | 消息内容                           |
| msg_type    | VARCHAR(20)  | 消息格式：text-文本, image-图片    |
| user_img    | VARCHAR(500) | 发送者头像 URL                     |
| create_time | DATETIME     | 发送时间                           |
| is_read     | TINYINT      | 是否已读：0-未读, 1-已读           |

## 部署步骤

### 1. 创建数据库表

```bash
cd wx_end
node config/initChatMessagesTable.js
```

### 2. 重启后端服务

```bash
# 停止当前运行的服务（如果有）
# 然后启动
node app.js
```

### 3. 重启前端服务

```bash
cd wx_front
npm run dev
```

## API 接口说明

### 后端接口

#### 1. 保存消息

- **URL**: `/api/chat/messages`
- **Method**: POST
- **说明**: 通过 WebSocket 自动保存，无需手动调用

#### 2. 获取群聊历史消息

- **URL**: `/api/chat/messages/group`
- **Method**: GET
- **参数**:
  - `limit`: 返回消息数量（默认 100）
  - `offset`: 偏移量（默认 0）

#### 3. 获取私聊历史消息

- **URL**: `/api/chat/messages/private`
- **Method**: GET
- **参数**:
  - `user1`: 用户 1 的用户名
  - `user2`: 用户 2 的用户名
  - `limit`: 返回消息数量（默认 100）
  - `offset`: 偏移量（默认 0）

#### 4. 获取私聊会话列表

- **URL**: `/api/chat/conversations`
- **Method**: GET
- **参数**:
  - `username`: 当前用户的用户名

#### 5. 标记消息已读

- **URL**: `/api/chat/messages/read`
- **Method**: PUT
- **参数**:
  - `messageIds`: 消息 ID 数组

### 前端 API 函数

```javascript
import {
  getGroupMessagesAPI, // 获取群聊历史
  getPrivateMessagesAPI, // 获取私聊历史
  getPrivateChatListAPI, // 获取私聊会话列表
  markMessagesAsReadAPI, // 标记消息已读
} from "@/api/allApi";
```

## 功能特点

### 1. 自动保存

- 所有通过 WebSocket 发送的消息（群聊和私聊）都会自动保存到数据库
- 无需手动调用保存接口

### 2. 自动加载

- 打开聊天页面时，自动加载最近 100 条群聊历史消息
- 打开私聊窗口时，自动加载与该用户的最近 100 条私聊历史消息

### 3. 消息去重

- 历史消息和新消息不会重复显示
- 私聊消息按照对话双方进行过滤

### 4. 时间排序

- 消息按发送时间升序排列
- 最新消息显示在底部

## 工作流程

### 群聊消息流程

1. 用户进入聊天页面
2. 系统自动加载历史群聊消息（最近 100 条）
3. 用户发送新消息
4. WebSocket 广播消息给所有在线用户
5. 后端自动将消息保存到数据库
6. 前端实时显示新消息

### 私聊消息流程

1. 用户点击某个在线用户
2. 打开私聊窗口
3. 系统自动加载与该用户的历史私聊消息
4. 用户发送私聊消息
5. WebSocket 发送消息给目标用户
6. 后端自动将消息保存到数据库
7. 双方都能看到完整的聊天历史

## 注意事项

1. **数据库连接**: 确保 `.env` 文件配置了正确的数据库连接信息
2. **WebSocket 连接**: 确保前端配置了正确的 WebSocket 地址
3. **用户名匹配**: 消息的发送者和接收者使用用户名（u_name）进行匹配
4. **性能优化**: 当前默认加载最近 100 条消息，可根据需要调整

## 扩展功能建议

1. **分页加载**: 实现上拉加载更多历史消息
2. **搜索功能**: 支持搜索历史消息内容
3. **消息已读状态**: 完善消息已读/未读功能
4. **消息撤回**: 支持撤回最近发送的消息
5. **消息转发**: 支持将消息转发给其他用户
6. **富文本消息**: 支持表情、图片、语音等多种消息类型

## 故障排查

### 问题 1: 历史消息加载失败

- 检查数据库表是否创建成功
- 检查后端服务是否正常运行
- 查看浏览器控制台和后端日志

### 问题 2: 新消息不保存

- 检查 WebSocket 连接是否正常
- 查看后端日志确认保存操作
- 确认数据库连接正常

### 问题 3: 私聊历史加载错误

- 确认用户名参数传递正确
- 检查数据库查询条件
- 查看控制台错误信息

## 技术栈

- **后端**: Node.js + Express + WebSocket + MySQL
- **前端**: Vue 3 + Pinia + NutUI
- **数据库**: MySQL 5.7+
